<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition template="./../../../WEB-INF/template/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core" 
                xmlns:pe="http://primefaces.org/ui/extensions"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:ui="http://java.sun.com/jsf/facelets">
    <ui:define name="breadcumb">
        #{navigations.naviguationApps('Calcul des commissions','modGescom', 'smenCalculCommission', true,managedCommission)}
    </ui:define> 
    <ui:define name="contents">
        <script type="text/javascript">
            var list = false;
            $(function() {
//                $('body').find('.part_scroll').height($('body').height() - $('body').find('.part_fix').height() - 180);
                $('body').find('.part_scroll').height($('body').height() - $('body').find('#top').height() - $('body').find('.zone_find').height() - $('body').find('.part_fix').height() - $('body').find('#bottom').height() - 30);
            });
        </script> 
        #{managedCaisses.loadAllCaisseActif(true)}  
        #{managedModeReglement.loadModels('C')}
        #{managedPeriodeObjectif.loadAllPeriodeObjectif(true)}
        #{managedCommerciaux.loadAllByAgence(0)}
        #{managedPointVente.loadAllPointVente()}

        #{managedCommission.loadAll()}
        <script type="text/javascript">
            $(function() {
                collapseList('calcul_commission');
            });
        </script>

        <h:form prependId="false">
            <p:dialog id="pbar_loading" hideEffect="explode" widgetVar="dlgPBar" closeOnEscape="true" header="Patientez svp..." resizable="false" modal="false">
                <p:progressBar id="progressBar" value="#{managedCommission.progress}" labelTemplate="{value}%" style="width:100%"/>                
            </p:dialog>
        </h:form>
        <h:form prependId="false">
            <p:confirmDialog hideEffect="explode" widgetVar="dlgConfirmDelete" closeOnEscape="true"
                             message="#{lab.LC_PRB_text1}" header="#{lab.L_confirmation}">
                <p:commandButton value="#{lab.L_oui}" actionListener="#{managedCommission.deleteBeanCommission()}" oncomplete="dlgConfirmDelete.hide()"/>
                <p:commandButton type="button"  value="#{lab.L_non}" onclick="dlgConfirmDelete.hide()"/>
            </p:confirmDialog>
        </h:form>
        <h:form prependId="false">
            <p:confirmDialog hideEffect="explode" widgetVar="dlgConfirmCalcul" closeOnEscape="true" header="#{lab.L_confirmation}"
                             message="#{lab.LC_PCC_text}">
                <p:commandButton value="#{lab.L_oui}" actionListener="#{managedCommission.calculCommission(true, false)}"
                                 oncomplete="dlgConfirmCalcul.hide();collapseList('calcul_commission')" update=":main_calcul_commission:blog_calcul_commission"/>
                <p:commandButton value="#{lab.L_non}" actionListener="#{managedCommission.calculCommission(false, true)}"
                                 oncomplete="dlgConfirmCalcul.hide();collapseList('calcul_commission')" update=":main_calcul_commission:blog_calcul_commission"/>
            </p:confirmDialog>
        </h:form>
        <h:form prependId="false">
            <p:confirmDialog hideEffect="explode" widgetVar="dlgConfirmDeleteMensualite_" closeOnEscape="true"
                             message="#{lab.LC_PCV_text2}" header="#{lab.L_confirmation}">
                <p:commandButton value="#{lab.L_oui}" actionListener="#{managedCommission.deleteBeanReglement_()}" oncomplete="dlgConfirmDeleteMensualite_.hide()"
                                 update=":main_calcul_commission:data_calcul_commercial_commercial:data_reglement_commission"/>
                <p:commandButton type="button"  value="#{lab.L_non}" onclick="dlgConfirmDeleteMensualite_.hide()"/>
            </p:confirmDialog>
        </h:form>
        <h:form prependId="false">
            <p:confirmDialog hideEffect="explode" widgetVar="dlgConfirmMaj" closeOnEscape="true" header="#{lab.L_confirmation}"
                             message="Certaines commisions existent pour cette période. Mettre à jour?">
                <p:commandButton value="#{lab.L_oui}" actionListener="#{managedCommission.majCommission()}"
                                 oncomplete="dlgConfirmMaj.hide()" update=":main_calcul_commission:data_calcul_commercial"/>
                <p:commandButton value="#{lab.L_non}" onclick="dlgConfirmMaj.hide()"/>
            </p:confirmDialog>
        </h:form>
        <h:form prependId="false">
            <p:confirmDialog hideEffect="explode" widgetVar="dlgConfirmPaye" closeOnEscape="true"
                             message="#{lab.LC_PFV_text27}" header="#{lab.L_confirmation}">
                <div >
                    <span>#{lab.LC_PFV_memoriser_choix_session}</span>
                    <p:selectBooleanCheckbox value="#{managedCommission.needConfirmation}" />
                </div>
                <p:commandButton value="#{lab.L_oui}" actionListener="#{managedCommission.reglerPieceTresorerie(true)}" oncomplete="dlgConfirmPaye.hide();collapseForm('yvs_list_calcul_commission')" 
                                 update=":main_calcul_commission:data_calcul_commercial_commercial:data_reglement_commission"/>
                <p:commandButton type="button"  value="#{lab.L_non}" onclick="dlgConfirmPaye.hide()"/>                
            </p:confirmDialog>
        </h:form>
        <h:form prependId="false" id="main-add_piece">
            <p:dialog hideEffect="explode" widgetVar="dlgAddReglement" closeOnEscape="true" header="Enregistrer un réglement" resizable="false">
                <h:panelGrid id="blog_form_reglement_commission" styleClass="yvs_table" columns="2" cellpadding="0" cellspacing="0" style="padding-top: 3px;padding-bottom: -5px">
                    <h:outputText value="#{lab.LC_PFV_mode} : " />                                               
                    <h:selectOneMenu value="#{managedCommission.reglement.mode.id}" id="select_model_reglement_commission" style="width: 100%">
                        <f:selectItem itemLabel="--" itemValue="0"/>
                        <f:selectItems value="#{managedModeReglement.modes}" var="modelm" itemLabel="#{modelm.designation}" itemValue="#{modelm.id}" />     
                    </h:selectOneMenu>  
                    <h:outputText value="#{lab.L_montant} : " />
                    <pe:inputNumber value="#{managedCommission.reglement.montant}"  style="text-align: right; width: 100%"/>
                    <h:outputText value="#{lab.LC_PFV_date_paiement} : " />
                    <p:calendar value="#{managedCommission.reglement.datePaiementPrevu}" navigator="true" pattern="dd-MM-yyyy" style="width: 100%"/>
                    <h:outputText value="#{lab.LC_PFV_caisse} : " />
                    <h:selectOneMenu value="#{managedCommission.reglement.caisse.id}" valueChangeListener="#{managedCommission.chooseCaisses}" style="width: 100%">
                        <f:selectItem itemLabel="" itemValue="0" />
                        <f:selectItems value="#{managedCaisses.caisses}" var="icaiss" itemLabel="#{icaiss.intitule}" itemValue="#{icaiss.id}" />
                        <p:ajax event="valueChange" update="chmp_caissier_reglement_fv"/>
                    </h:selectOneMenu>
                    <h:outputText value="#{lab.LC_PFV_caissier} : " />
                    <h:selectOneMenu id="chmp_caissier_reglement_fv" value="#{managedCommission.reglement.caissier.id}" style="width: 100%" disabled="#{!accesRessource.compta_reg_fv_change_caissier}">
                        <f:selectItem itemLabel="" itemValue="0" />
                        <f:selectItems value="#{managedCommission.caissiers}" var="iCaissier" itemLabel="#{iCaissier.nomUsers}" itemValue="#{iCaissier.id}" />
                        <p:ajax event="valueChange"/>
                    </h:selectOneMenu>
                    <h:outputText value="#{lab.LC_PFV_statut} : "  />
                    <h:selectOneMenu value="#{managedCommission.reglement.statutPiece}" disabled="#{managedCommission.reglement.statutPiece != constantes.STATUT_DOC_ATTENTE}" style="width: 100%">
                        <f:selectItem itemValue="#{constantes.STATUT_DOC_PAYER}" itemLabel="#{lab.LC_PFV_regler}" />
                        <f:selectItem itemValue="#{constantes.STATUT_DOC_ATTENTE}" itemLabel="#{lab.LC_PFV_en_attente}" />                                                    
                        <f:selectItem itemValue="#{constantes.STATUT_DOC_ENCOUR}" itemLabel="#{lab.LC_PFV_en_cours}" itemDisabled="true"/>                                                    
                    </h:selectOneMenu>
                    <f:facet name="footer">                        
                        <p:commandButton id="save_reglement_commission" icon="ui-icon-circle-plus" style="float: right" value="#{lab.L_enregistrer}"
                                         update=":main_calcul_commission:data_calcul_commercial_commercial:data_reglement_commission"
                                         actionListener="#{managedCommission.saveNewReglement()}" oncomplete="dlgAddReglement.hide()"/>
                    </f:facet>
                </h:panelGrid>    
            </p:dialog>
        </h:form>

        <h:form prependId="false" id="main-charger">
            <p:dialog hideEffect="explode" widgetVar="dlgAFilterCharger" closeOnEscape="true" header="Calculer les commissions" resizable="false">
                <h:panelGrid columns="2"  styleClass="yvs_table" style="padding-top: 3px;padding-bottom: -5px">
                    <h:outputText value="#{lab.LC_PCC_periode} :"/>
                    <h:selectOneMenu value="#{managedCommission.idPeriode}" style="width: 100%">
                        <f:selectItem itemLabel="--" itemValue="0"/>
                        <f:selectItems value="#{managedPeriodeObjectif.periodes}" var="per" itemLabel="#{per.codeRef}" itemValue="#{per.id}"/>
                        <p:ajax event="valueChange" global="false"/>
                    </h:selectOneMenu>
                    <h:outputText value="#{lab.LC_POV_commercial} :"/>
                    <h:selectOneMenu value="#{managedCommission.idCommercial}" style="width: 100%">
                        <f:selectItem itemLabel="--" itemValue="0"/>
                        <f:selectItems value="#{managedCommerciaux.commerciaux}" var="com" itemLabel="#{com.nom_prenom}" itemValue="#{com.id}"/>
                        <p:ajax event="valueChange" global="false"/>
                    </h:selectOneMenu>
                    <h:outputText value="#{lab.L_point_vente} :"/>
                    <h:selectOneMenu value="#{managedCommission.idPoint}" style="width: 100%">
                        <f:selectItem itemLabel="--" itemValue="0"/>
                        <f:selectItems value="#{managedPointVente.pointsvente}" var="ptv" itemLabel="#{ptv.libelle}" itemValue="#{ptv.id}"/>
                        <p:ajax event="valueChange" global="false"/>
                    </h:selectOneMenu>
                    <f:facet name="footer">
                        <p:selectBooleanCheckbox  value="#{managedCommission.autoCalcul}" style="float: left;margin-top: 7px" itemLabel="Enregistrer automatiquement :"/>
                        <p:commandButton value="Calculer" actionListener="#{managedCommission.calculCommission(false, false)}" update=":main_calcul_commission:blog_calcul_commission :main_calcul_commission:data_calcul_commercial"
                                         oncomplete="dlgAFilterCharger.hide(); collapseList('calcul_commission')" style="float: right"/>
                    </f:facet>
                </h:panelGrid>
            </p:dialog>
        </h:form>
        <h:form prependId="false">
            <p:dialog hideEffect="explode" widgetVar="dlgPrint" closeOnEscape="true" header="Télécharger les commissions" resizable="false">
                <h:panelGrid columns="2"  styleClass="yvs_table" style="padding-top: 3px;padding-bottom: -5px">
                    <h:outputText value="#{lab.LC_PCC_periode} :"/>
                    <h:selectOneMenu value="#{managedCommission.idPeriode}" style="width: 100%">
                        <f:selectItem itemLabel="--" itemValue="0"/>
                        <f:selectItems value="#{managedPeriodeObjectif.periodes}" var="per" itemLabel="#{per.codeRef}" itemValue="#{per.id}"/>
                        <p:ajax event="valueChange" global="false"/>
                    </h:selectOneMenu>
                    <h:outputText value="#{lab.LC_POV_commercial} :"/>
                    <h:selectOneMenu value="#{managedCommission.idCommercial}" style="width: 100%">
                        <f:selectItem itemLabel="--" itemValue="0"/>
                        <f:selectItems value="#{managedCommerciaux.commerciaux}" var="com" itemLabel="#{com.nom_prenom}" itemValue="#{com.id}"/>
                        <p:ajax event="valueChange" global="false"/>
                    </h:selectOneMenu>
                    <f:facet name="footer">
                        <div align="right">
                            <p:commandButton value="Télécharger le total" actionListener="#{managedCommission.downloadCommission(true)}" ajax="false"/>
                            <p:commandButton value="Télécharger le détail" actionListener="#{managedCommission.downloadCommission(false)}" ajax="false"/>
                        </div>
                    </f:facet>
                </h:panelGrid>
            </p:dialog>
        </h:form>
        <!-->
        *****************************************************************************
        Début du formulaire
        *****************************************************************************
        <-->
        <h:form prependId="false" id="main_calcul_commission">
            <div class="part_fix" align="right" style="font-size: 0.8em;"> 
                <div style="float: left;">
                    <p:splitButton value="#{lab.L_options}" id="btn_calcul_commission" icon="ui-icon-gear" type="button">
                        <p:menuitem icon="ui-icon-arrow-4" value="Calculer commission" global="false" oncomplete="dlgAFilterCharger.show()"/>                            
                        <p:menuitem icon="ui-icon-print" value="Télécharger commission" global="false" oncomplete="dlgPrint.show()" style="width: 220px"/>                            
                    </p:splitButton>
                </div>
                <div style="float: right">
                    <div style="float: right">
                        <h:link title="#{lab.LC_PCC_mode_facture}" onclick="collapseForm('calcul_commission');
                                return false">
                            <p:graphicImage library="icones" name="newDoc.png" width="18" height="25" style="border: 2px solid #666; border-radius: 5px;"/>
                        </h:link>               
                        <p:spacer />
                        <h:link title="#{lab.LC_PCC_vue_commerciaux}" onclick="collapseList('calcul_commission');
                                return false" >
                            <p:graphicImage library="icones" name="ico_formulaire.png" width="18" height="25" style="border: 2px solid #666; border-radius: 5px;background: white!important"/>
                        </h:link>   
                    </div>
                </div>
                <span style="display: inline-block; clear: both" />
            </div>
            <div class="part_scroll" style="width: 99%; margin: auto; background: white">
                <p:outputPanel id="blog_calcul_commission">
                    <div class="yvs_form_calcul_commission"> 
                        <h:panelGrid id="form_calcul_commission_commercial" columns="1" cellpadding="0" cellspacing="0" style="width: 100%">
                            <h:panelGroup rendered="#{managedCommission.commercial.id gt 0}">
                                <h:panelGroup style="float: left;padding-bottom: 5px">
                                    <span>#{lab.LC_PPV_montant} :</span>
                                    <h:outputText value="#{managedCommission.commercial.montant}" style="font-weight: bold" converter="DN"/>
                                    <h:panelGroup style="margin-left: 10px">
                                        <p:commandLink value="EN ATTENTE" process="@this" disabled="true" styleClass="button-stateOF #{(managedCommission.commercial.statutRegle == constantes.ETAT_ATTENTE)?'button-stateOF_actif':''}"/>
                                        <p:commandLink value="EN COURS" process="@this" disabled="true" styleClass="button-stateOF #{(managedCommission.commercial.statutRegle == constantes.ETAT_ENCOURS)?'button-stateOF_actif':''}"/>
                                        <p:commandLink value="PAYER" process="@this" disabled="true" styleClass="button-stateOF #{(managedCommission.commercial.statutRegle == constantes.ETAT_REGLE)?'button-stateOF_actif':''}"/>
                                    </h:panelGroup>
                                </h:panelGroup>
                                <h:panelGroup id="statut_commission" style="float: right;padding-bottom: 5px">
                                    <p:commandLink value="#{managedCommission.commercial.statut == constantes.ETAT_EDITABLE?'EN EDITION':'EDITABLE'}" type="button"
                                                   disabled="#{(managedCommission.commercial.statut == constantes.ETAT_EDITABLE)}" styleClass="#{(managedCommission.commercial.statut == constantes.ETAT_EDITABLE)?'statut_valide':'etat_formation_true'}"                                                           
                                                   actionListener="#{managedCommission.changeStatutCommission(constantes.ETAT_EDITABLE)}" update="statut_commission"/>
                                    <p:commandLink value="EN COURS" process="@this" disabled="true" styleClass="#{(managedCommission.commercial.statut == constantes.ETAT_ENCOURS)?'statut_valide':'etat_formation_true'}"/>
                                    <p:commandLink value="#{(managedCommission.commercial.statut == constantes.ETAT_VALIDE)?'VALIDE':'VALIDER'}" process="@this"  
                                                   disabled="#{!(managedCommission.commercial.statut == constantes.ETAT_EDITABLE)}" styleClass="#{(managedCommission.commercial.statut == constantes.ETAT_VALIDE)?'statut_valide':'etat_formation_true'}"                                                           
                                                   actionListener="#{managedCommission.changeStatutCommission(constantes.ETAT_VALIDE)}" update="statut_commission"/>

                                </h:panelGroup>
                            </h:panelGroup>
                            <p:tabView id="data_calcul_commercial_commercial">
                                <p:tab title="#{lab.LC_PCC_factures}">
                                    <p:dataTable value="#{managedCommission.commercial.factures}" id="tab_factures" var="com" rowKey="#{com.id}" rowIndexVar="bonIdx"
                                                 style="height: 400px; overflow-y: auto">
                                        <p:column style="width:16px">
                                            <p:rowToggler/>
                                        </p:column>
                                        <p:column width="35" headerText="N°" styleClass="statut_#{bon.statut}">
                                            <span>#{bonIdx+1}</span>
                                        </p:column>
                                        <p:column headerText="#{lab.L_reference}" styleClass="statut_#{com.facture.statut}">
                                            <span>#{com.facture.numDoc}</span>
                                        </p:column>
                                        <p:column headerText="#{lab.LC_PCC_date_facture}" style="text-align: center" styleClass="statut_#{com.facture.statut}">
                                            <h:outputText value="#{com.facture.enteteDoc.dateEntete}" converter="DDMMYYYY"/>
                                            <span> #{lab.L_a} </span>
                                            <h:outputText value="#{com.facture.heureDoc}" converter="TIME"/>
                                        </p:column>
                                        <p:column headerText="#{lab.LC_PCC_client}" styleClass="statut_#{com.facture.statut}">
                                            <span>#{com.facture.nom_client}</span>
                                            <h:outputText value="cmd" title="#{lab.LC_PCC_rattacher_commande}" style="color: blue;float: right;font-size: 0.7em;font-style: italic"
                                                          rendered="#{com.facture.documentLie.id > 0}"/>
                                        </p:column>
                                        <p:column headerText="#{lab.LC_PCC_ca}" style="text-align: right" styleClass="statut_#{com.facture.statut}">
                                            <h:outputText value="#{managedCommission.loadCaVente(com.facture)}" converter="DN" />
                                        </p:column>
                                        <p:column headerText="#{lab.L_total}" width="60" styleClass="statut_#{com.facture.statut}" style="font-size: 0.8em;text-align: right">
                                            <h:outputText value="#{com.facture.commision}" converter="DNS" />
                                        </p:column>
                                        <p:column headerText="#{lab.LC_PCC_commission}"  width="60" styleClass="statut_#{com.facture.statut}" style="font-size: 0.8em;text-align: right">
                                            <h:outputText value="#{com.facture.commision * com.taux / 100}" converter="DNS" />
                                        </p:column>
                                        <p:rowExpansion>
                                            <p:dataTable id="data_contenu_facture_commission" value="#{com.facture.contenus}" var="art" rowKey="#{art.id}"  rowIndexVar="Idx">
                                                <p:column headerText="N°" style="width: 5%;color: #{art.etat()=='R'?'orange':(art.etat()=='P'?'red':'')};font-style: #{art.etat()!='E'?'italic':''}">
                                                    <h:graphicImage library="img" name="redo.png" width="15" height="15" rendered="#{art.new_}"/>
                                                    <span title="#{lab.LC_PCC_num_serie} : #{art.numSerie}">#{Idx+1}</span>
                                                </p:column>
                                                <p:column headerText="#{lab.L_ref}. " style="width: 12%;color: #{art.etat()=='R'?'orange':(art.etat()=='P'?'red':'')};font-style: #{art.etat()!='E'?'italic':''}">
                                                    <span title="#{lab.LC_PCC_num_serie} : #{art.numSerie}">#{art.article.refArt}</span>
                                                    <h:graphicImage library="img" name="comment.png" width="15" height="15" rendered="#{art.onComment}" style="float: right" title="#{lab.LC_PCC_a_ete_commente}"/>
                                                </p:column>
                                                <p:column headerText="#{lab.L_article}" style="color: #{art.etat()=='R'?'orange':(art.etat()=='P'?'red':'')};font-style: #{art.etat()!='E'?'italic':''}">
                                                    <span title="#{lab.LC_PCC_num_serie} : #{art.numSerie}">#{art.article.designation}</span>
                                                    <h:outputText title="#{lab.LC_PCC_facture_consignee}" value="C" rendered="#{art.idReservation ne null}"
                                                                  style="font-weight: bold;border: 2px solid #666; border-radius: 5px;padding: 1px;background: black;color: white; float: right"/>
                                                </p:column>
                                                <p:column headerText="#{lab.L_qte}" style="width: 8%;text-align: center;color: #{art.etat()=='R'?'orange':(art.etat()=='P'?'red':'')};font-style: #{art.etat()!='E'?'italic':''}">
                                                    <h:outputText value="#{art.quantite}" converter="DN" title="Plus #{art.quantiteBonus} #{lab.L_bonus}"/>
                                                    <span title="#{art.conditionnement.unite.libelle}" style="font-size: 0.6em;color: #003399">#{art.conditionnement.unite.reference}</span>
                                                </p:column>
                                                <p:column headerText="#{lab.L_prix}" style="width: 10%;text-align: right;color: #{art.etat()=='R'?'orange':(art.etat()=='P'?'red':'')};font-style: #{art.etat()!='E'?'italic':''}">
                                                    <h:outputText value="#{art.prix - art.rabais}" converter="DN" title="#{lab.LC_PCC_num_serie} : #{art.numSerie}"/>
                                                </p:column>
                                                <p:column headerText="#{lab.L_rem}" style="width: 10%;text-align: right;color: #{art.etat()=='R'?'orange':(art.etat()=='P'?'red':'')};font-style: #{art.etat()!='E'?'italic':''}">
                                                    <h:outputText value="#{art.remise}" converter="DNS" title="#{lab.LC_PCC_num_serie} : #{art.numSerie}"/>
                                                </p:column>
                                                <p:column headerText="#{lab.L_taxe}" style="width: 10%;text-align: right;color: #{art.etat()=='R'?'orange':(art.etat()=='P'?'red':'')};font-style: #{art.etat()!='E'?'italic':''}">
                                                    <h:outputText value="#{art.taxe}" converter="DNS" title="#{lab.LC_PCC_num_serie} : #{art.numSerie}"/>
                                                </p:column>
                                                <p:column headerText="#{lab.LC_PCC_commission}" style="width: 10%;text-align: right;color: #{art.etat()=='R'?'orange':(art.etat()=='P'?'red':'')};font-style: #{art.etat()!='E'?'italic':''}">
                                                    <h:outputText value="#{art.comission}" converter="DNS" title="#{lab.LC_PCC_num_serie} : #{art.numSerie}"/>
                                                </p:column>
                                                <p:column headerText="#{lab.L_total}" style="width: 12%;text-align: right;color: #{art.etat()=='R'?'orange':(art.etat()=='P'?'red':'')};font-style: #{art.etat()!='E'?'italic':''}">
                                                    <h:outputText value="#{art.prixTotal}" converter="DNS" title="#{lab.LC_PCC_num_serie} : #{art.numSerie}"/>
                                                </p:column>
                                            </p:dataTable>
                                        </p:rowExpansion>
                                    </p:dataTable> 
                                    <h:inputText value="#{managedCommission.factureSearch}">
                                        <p:ajax event="valueChange" listener="#{managedCommission.onSearchFacture()}" update="data_calcul_commercial_commercial:tab_factures"/>
                                    </h:inputText>
                                    <div style="clear: both"/>
                                </p:tab>
                                <p:tab title="#{lab.LC_PCC_reglement_commission}">
                                    <p:commandButton icon="ui-icon-circle-plus" actionListener="#{managedCommission.resetFicheReglement()}" style="float: right"
                                                     update=":main-add_piece:blog_form_reglement_commission" oncomplete="dlgAddReglement.show()"/>
                                    <p:dataTable id="data_reglement_commission" value="#{managedCommission.commercial.reglements}" var="men" rowKey="#{men.id}" 
                                                 rowIndexVar="menIdx" selectionMode="single" selection="#{managedCommission.selectReglement}">
                                        <p:ajax event="rowSelect" listener="#{managedCommission.loadOnViewMensualite}" oncomplete="dlgAddReglement.show()"
                                                update=":main-add_piece:blog_form_reglement_commission :main_calcul_commission:data_calcul_commercial_commercial:zone_auteur_reg_fv"/>
                                        <p:ajax event="rowUnselect" global="false" listener="#{managedCommission.unLoadOnViewMensualite}"
                                                update=":main-add_piece:blog_form_reglement_commission :main_calcul_commission:data_calcul_commercial_commercial:zone_auteur_reg_fv"/>                                                                                           
                                        <p:column headerText="N°" width="20" style="text-align: center" styleClass="statut_#{managedCommission.giveStringStatut(men.statutPiece)}">
                                            <h:graphicImage library="img" name="redo.png" width="15" height="15" rendered="#{men.new_}"/>
                                            <h:panelGroup style="float: right">
                                                <h:outputText title="#{lab.LC_PFV_comptabilise}" value="C" rendered="#{men.comptabilise}" styleClass="style_statut"/>
                                            </h:panelGroup>
                                        </p:column>
                                        <p:column headerText="#{lab.LC_PFV_mode}" styleClass="statut_#{managedCommission.giveStringStatut(men.statutPiece)}">
                                            <h:outputText value="#{men.model.designation}"/>
                                        </p:column>
                                        <p:column headerText="#{lab.LC_PFV_piece_numero}" sortBy="#{men.datePiece}" style="text-align: center" styleClass="statut_#{managedCommission.giveStringStatut(men.statutPiece)}">
                                            <h:outputText value="#{men.numeroPiece}"/>
                                        </p:column>
                                        <p:column headerText="#{lab.LC_PFV_date_reglement}" sortBy="#{men.datePaimentPrevu}" style="text-align: center" styleClass="statut_#{managedCommission.giveStringStatut(men.statutPiece)}">
                                            <h:outputText value="#{(men.statutPiece eq constantes.STATUT_DOC_PAYER)?men.datePaiement:men.datePaimentPrevu}" converter="DATE"/>
                                        </p:column>
                                        <p:column headerText="#{lab.LC_PFV_caisses}" style="width: 17%;text-align: right" styleClass="statut_#{managedCommission.giveStringStatut(men.statutPiece)}">
                                            <h:outputText value="#{men.caisse.intitule}" />
                                        </p:column>
                                        <p:column headerText="#{lab.L_montant}" style="width: 17%;text-align: right" styleClass="statut_#{managedCommission.giveStringStatut(men.statutPiece)}">                                                
                                            <h:outputText value="#{men.montant}" converter="#{managedCommission.converter}"/>                                                
                                        </p:column>
                                        <p:column style="width: 5%;text-align: center" styleClass="statut_#{managedCommission.giveStringStatut(men.statutPiece)}">
                                            <p:contextMenu for="btn_option_reglement_commission" event="left click" style="font-size: 0.8em" styleClass="context_menu">
                                                <p:menuitem value="#{((men.statutPiece==constantes.STATUT_DOC_PAYER) or (men.statutPiece==constantes.STATUT_DOC_ANNULE))?'En attente':'Payer'}" 
                                                            icon="#{((men.statutPiece==constantes.STATUT_DOC_PAYER) or (men.statutPiece==constantes.STATUT_DOC_ANNULE))?'ui-icon-arrowreturnthick-1-s':'ui-icon-circle-check'}" 
                                                            actionListener="#{managedCommission.deleteBeanReglement_(men)}" oncomplete="dlgConfirmPaye.show()"/>
                                                <p:menuitem value="#{lab.L_telecharger}" title="#{lab.LCF_PPC_telecharger_piece}" action="#{managedCommission.printPiece(men)}" ajax="false" icon="ui-icon-print"/> 
                                                <p:separator style="width: 98%;margin: auto"/>
                                                <p:menuitem value="#{lab.L_supprimer}" icon="ui-icon-trash" oncomplete="dlgConfirmDeleteMensualite_.show()"  
                                                            actionListener="#{managedCommission.deleteBeanReglement_(men)}"/>
                                            </p:contextMenu>                           
                                            <p:commandButton icon="ui-icon-gear" style="width: 22px; height: 22px" id="btn_option_reglement_commission" type="button"/>
                                        </p:column> 
                                    </p:dataTable>
                                    <div style="clear: both"/>
                                    <div style="margin-bottom: -20px; font-size: 0.7em" align="right">
                                        <h:panelGroup  id="zone_auteur_reg_fv">
                                            <span>#{lab.L_par} </span>
                                            <h:outputText value="#{managedCommission.selectReglement.author.users.nomUsers}" />
                                            <span>#{lab.L_le} </span>
                                            <h:outputText value="#{managedCommission.selectReglement.dateUpdate}" converter="DATETIME" />
                                        </h:panelGroup>
                                    </div>
                                    <div style="clear: both"/>
                                </p:tab>
                            </p:tabView>   
                        </h:panelGrid>
                    </div>
                    <div class="yvs_list_calcul_commission" style="overflow-y: auto" >
                        <p:dataTable id="data_calcul_commercial" value="#{managedCommission.commissions}" var="usr"
                                     rowKey="#{usr.id}" selectionMode="single" rowIndexVar="xIdx">
                            <p:ajax event="rowSelect" listener="#{managedCommission.loadOnViewCommercial}" oncomplete="collapseForm('calcul_commission')"
                                    update=":main_calcul_commission:form_calcul_commission_commercial"/>
                            <p:ajax event="rowUnselect" listener="#{managedCommission.unLoadOnViewCommercial}" oncomplete="collapseForm('calcul_commission')" 
                                    update=":main_calcul_commission:form_calcul_commission_commercial" />
                            <p:column width="35" style="text-align: center" styleClass="statut_#{usr.statut}">
                                <h:graphicImage library="img" name="redo.png" width="15" height="15" rendered="#{usr.new_}"/>
                                <span>#{xIdx+1}</span>
                                <h:graphicImage library="img" name="pointe.png" width="17" height="15" rendered="#{usr.id eq managedCommission.commercial.id}"/>
                            </p:column>
                            <p:column headerText="#{lab.LC_PCC_noms_prenoms}" styleClass="statut_#{usr.statut}" >
                                <span>#{usr.commerciaux.nom_prenom}</span>
                            </p:column> 
                            <p:column headerText="#{lab.L_numero}" style="text-align: center" styleClass="statut_#{usr.statut}">
                                <span style="font-weight: bold">#{usr.numero}</span>
                            </p:column>
                            <p:column headerText="#{lab.L_periode}" styleClass="statut_#{usr.statut}">
                                <h:outputText value="#{usr.periode.codeRef}"/>
                            </p:column>
                            <p:column headerText="#{lab.L_date_debut}" style="text-align: center" styleClass="statut_#{usr.statut}">
                                <h:outputText value="#{usr.periode.dateDebut}" converter="DATE"  />
                            </p:column>
                            <p:column headerText="#{lab.L_date_fin}" style="text-align: center" styleClass="statut_#{usr.statut}">
                                <h:outputText value="#{usr.periode.dateFin}" converter="DATE"  />
                            </p:column>
                            <p:column headerText="#{lab.LC_PCC_ca}" style="text-align: right" styleClass="statut_#{usr.statut}">
                                <h:outputText value="#{managedCommission.loadCaCommercial(usr)}" converter="DN" />
                            </p:column>
                            <p:column headerText="#{lab.LC_PCC_commission}" style="text-align: right" styleClass="statut_#{usr.statut}">
                                <h:outputText value="#{usr.montant}" converter="DNS" />
                            </p:column>
                            <p:column width="20" style="text-align: center" styleClass="statut_#{usr.statut}">
                                <p:contextMenu for="btn_option_commission" event="left click" style="font-size: 0.8em" styleClass="context_menu">  
                                    <p:menuitem value="#{usr.id gt 0 ? lab.L_modifier : lab.L_enregistrer}" icon="ui-icon-disk" actionListener="#{managedCommission.saveCommission(usr, true)}"
                                                update=":main_calcul_commission:data_calcul_commercial" disabled="#{!usr.new_}"/>
                                    <p:menuitem value="#{usr.statut eq constantes.ETAT_VALIDE ? 'Annuler' : 'Valider'}" icon="#{usr.statut eq constantes.ETAT_VALIDE ? 'ui-icon-cancel' : 'ui-icon-check'}" rendered="#{usr.id gt 0}"
                                                actionListener="#{managedCommission.changeStatutCommission(usr, (usr.statut eq constantes.ETAT_VALIDE ? constantes.ETAT_ATTENTE : constantes.ETAT_VALIDE))}"/>
                                    <p:menuitem value="#{lab.L_supprimer}" icon="ui-icon-trash" global="false" actionListener="#{managedCommission.setSelectCommission(usr)}"
                                                oncomplete="dlgConfirmDelete.show()" disabled="#{usr.id le 0}"/>
                                </p:contextMenu>                           
                                <p:commandButton icon="ui-icon-gear" style="width: 22px; height: 22px" id="btn_option_commission" type="button"/>
                            </p:column> 
                        </p:dataTable> 
                        <span class="nbSelectcalcul_commission" style="font-size: .8em; font-style: italic; color: #828c95;"></span>
                        <p:outputPanel autoUpdate="true" style="float: right;" layout="block" >
                            <p:commandButton actionListener="#{managedCommission.load(false, false)}"  update="data_calcul_commercial" icon="ui-icon-circle-triangle-w" disabled="#{managedCommission.paginators.disPrev}"/>
                            <p:outputPanel >
                                <p:inplace label="#{managedCommission.paginators.currentPage}" style="margin-top: 15px; font-size: 0.8em; font-weight: bold">
                                    <pe:inputNumber value="#{managedCommission.paginators.gotoPage}" style="width: 30px;text-align: center" decimalPlaces="0">
                                        <p:ajax event="valueChange" listener="#{managedCommission.gotoPagePaginators()}" update="data_calcul_commercial"/>
                                    </pe:inputNumber>
                                </p:inplace><p:outputLabel value="/#{managedCommission.paginators.nbPage}" style="margin-top: 15px; font-size: 0.8em; font-weight: bold" />
                            </p:outputPanel>
                            <p:commandButton actionListener="#{managedCommission.load(true, false)}"  update="data_calcul_commercial" icon="ui-icon-circle-triangle-e" disabled="#{managedCommission.paginators.disNext}"/>
                            <p:selectOneMenu value="#{managedCommission.imax}" label="#{lab.L_nombre_max_resultat}" valueChangeListener="#{managedCommission.choosePaginators}" style="float: right; font-size: 0.9em;margin-top: 3px;min-width: 50px" >
                                <f:selectItems value="#{managedCommission.paginations}"/>
                                <p:ajax event="valueChange"  update="data_calcul_commercial"  />
                            </p:selectOneMenu>
                        </p:outputPanel>
                    </div>                       
                </p:outputPanel>    
            </div>   
        </h:form>  
    </ui:define>
    <ui:define name="zone_search">
        <h:form prependId="false">
            <h:graphicImage library="img"  name="pointe_.png" style="border: none; position: relative" width="20" height="20"
                            styleClass="img_slide" title="cacher"/>                    
            <div class="zone_find">                
                <div class="display_auteur" align="right" style="font-style: italic;">
                    <p:outputPanel autoUpdate="true">
                        <span style="float: left">Enregistré Le <h:outputText value="#{Marticle.entityArticle.dateSave}" styleClass="valeur" converter="DTL" style="font-weight: bold"/></span>
                        <span>Modifier Le <h:outputText value="#{Marticle.entityArticle.dateUpdate}" styleClass="valeur" converter="DTL" style="font-weight: bold"/></span>
                        <span>Par <h:outputText value="#{Marticle.entityArticle.author.users.nomUsers}" style="font-weight: bold" styleClass="valeur" /></span>
                    </p:outputPanel>
                </div>
                <h:panelGrid columns="2" style="width: 100%; font-size: 0.8em">
                    <h:panelGrid columns="3" style="float: left; font-size: 1.0em">
                        <h:outputText value="#{lab.L_reference}" />
                        <h:outputText value="#{lab.L_periode}" />
                        <h:outputText value="#{lab.LC_POV_commercial} :"/>
                        <h:inputText value="#{managedCommission.numeroSearch}">
                            <p:ajax event="valueChange" listener="#{managedCommission.addParamNumero()}" 
                                    process="@form" update=":main_calcul_commission:data_calcul_commercial "/>  
                        </h:inputText>
                        <h:selectOneMenu value="#{managedCommission.periodeSearch}" style="min-width: 120px">
                            <f:selectItem itemLabel="--" itemValue="0"/>
                            <f:selectItems value="#{managedPeriodeObjectif.periodes}" var="per" itemLabel="#{per.codeRef}" itemValue="#{per.id}"/>
                            <p:ajax event="valueChange" listener="#{managedCommission.addParamPeriode()}"  
                                    process="@form" update=":main_calcul_commission:data_calcul_commercial "/>  
                        </h:selectOneMenu>
                        <h:selectOneMenu value="#{managedCommission.commercialSearch}" style="min-width: 120px">
                            <f:selectItem itemLabel="--" itemValue="0"/>
                            <f:selectItems value="#{managedCommerciaux.commerciaux}" var="com" itemLabel="#{com.nom_prenom}" itemValue="#{com.id}"/>
                            <p:ajax event="valueChange" listener="#{managedCommission.addParamCommercial()}"  
                                    process="@form" update=":main_calcul_commission:data_calcul_commercial "/>  
                        </h:selectOneMenu>
                    </h:panelGrid>

                </h:panelGrid>

            </div>
        </h:form>
    </ui:define>
</ui:composition>
